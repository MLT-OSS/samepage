/*
 *
 *                                  Apache License
 *                            Version 2.0, January 2004
 *                         https://www.apache.org/licenses/
 *
 *    TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
 *
 *    1. Definitions.
 *
 *       "License" shall mean the terms and conditions for use, reproduction,
 *       and distribution as defined by Sections 1 through 9 of this document.
 *
 *       "Licensor" shall mean the copyright owner or entity authorized by
 *       the copyright owner that is granting the License.
 *
 *       "Legal Entity" shall mean the union of the acting entity and all
 *       other entities that control, are controlled by, or are under common
 *       control with that entity. For the purposes of this definition,
 *       "control" means (i) the power, direct or indirect, to cause the
 *       direction or management of such entity, whether by contract or
 *       otherwise, or (ii) ownership of fifty percent (50%) or more of the
 *       outstanding shares, or (iii) beneficial ownership of such entity.
 *
 *       "You" (or "Your") shall mean an individual or Legal Entity
 *       exercising permissions granted by this License.
 *
 *       "Source" form shall mean the preferred form for making modifications,
 *       including but not limited to software source code, documentation
 *       source, and configuration files.
 *
 *       "Object" form shall mean any form resulting from mechanical
 *       transformation or translation of a Source form, including but
 *       not limited to compiled object code, generated documentation,
 *       and conversions to other media types.
 *
 *       "Work" shall mean the work of authorship, whether in Source or
 *       Object form, made available under the License, as indicated by a
 *       copyright notice that is included in or attached to the work
 *       (an example is provided in the Appendix below).
 *
 *       "Derivative Works" shall mean any work, whether in Source or Object
 *       form, that is based on (or derived from) the Work and for which the
 *       editorial revisions, annotations, elaborations, or other modifications
 *       represent, as a whole, an original work of authorship. For the purposes
 *       of this License, Derivative Works shall not include works that remain
 *       separable from, or merely link (or bind by name) to the interfaces of,
 *       the Work and Derivative Works thereof.
 *
 *       "Contribution" shall mean any work of authorship, including
 *       the original version of the Work and any modifications or additions
 *       to that Work or Derivative Works thereof, that is intentionally
 *       submitted to Licensor for inclusion in the Work by the copyright owner
 *       or by an individual or Legal Entity authorized to submit on behalf of
 *       the copyright owner. For the purposes of this definition, "submitted"
 *       means any form of electronic, verbal, or written communication sent
 *       to the Licensor or its representatives, including but not limited to
 *       communication on electronic mailing lists, source code control systems,
 *       and issue tracking systems that are managed by, or on behalf of, the
 *       Licensor for the purpose of discussing and improving the Work, but
 *       excluding communication that is conspicuously marked or otherwise
 *       designated in writing by the copyright owner as "Not a Contribution."
 *
 *       "Contributor" shall mean Licensor and any individual or Legal Entity
 *       on behalf of whom a Contribution has been received by Licensor and
 *       subsequently incorporated within the Work.
 *
 *    2. Grant of Copyright License. Subject to the terms and conditions of
 *       this License, each Contributor hereby grants to You a perpetual,
 *       worldwide, non-exclusive, no-charge, royalty-free, irrevocable
 *       copyright license to reproduce, prepare Derivative Works of,
 *       publicly display, publicly perform, sublicense, and distribute the
 *       Work and such Derivative Works in Source or Object form.
 *
 *    3. Grant of Patent License. Subject to the terms and conditions of
 *       this License, each Contributor hereby grants to You a perpetual,
 *       worldwide, non-exclusive, no-charge, royalty-free, irrevocable
 *       (except as stated in this section) patent license to make, have made,
 *       use, offer to sell, sell, import, and otherwise transfer the Work,
 *       where such license applies only to those patent claims licensable
 *       by such Contributor that are necessarily infringed by their
 *       Contribution(s) alone or by combination of their Contribution(s)
 *       with the Work to which such Contribution(s) was submitted. If You
 *       institute patent litigation against any entity (including a
 *       cross-claim or counterclaim in a lawsuit) alleging that the Work
 *       or a Contribution incorporated within the Work constitutes direct
 *       or contributory patent infringement, then any patent licenses
 *       granted to You under this License for that Work shall terminate
 *       as of the date such litigation is filed.
 *
 *    4. Redistribution. You may reproduce and distribute copies of the
 *       Work or Derivative Works thereof in any medium, with or without
 *       modifications, and in Source or Object form, provided that You
 *       meet the following conditions:
 *
 *       (a) You must give any other recipients of the Work or
 *           Derivative Works a copy of this License; and
 *
 *       (b) You must cause any modified files to carry prominent notices
 *           stating that You changed the files; and
 *
 *       (c) You must retain, in the Source form of any Derivative Works
 *           that You distribute, all copyright, patent, trademark, and
 *           attribution notices from the Source form of the Work,
 *           excluding those notices that do not pertain to any part of
 *           the Derivative Works; and
 *
 *       (d) If the Work includes a "NOTICE" text file as part of its
 *           distribution, then any Derivative Works that You distribute must
 *           include a readable copy of the attribution notices contained
 *           within such NOTICE file, excluding those notices that do not
 *           pertain to any part of the Derivative Works, in at least one
 *           of the following places: within a NOTICE text file distributed
 *           as part of the Derivative Works; within the Source form or
 *           documentation, if provided along with the Derivative Works; or,
 *           within a display generated by the Derivative Works, if and
 *           wherever such third-party notices normally appear. The contents
 *           of the NOTICE file are for informational purposes only and
 *           do not modify the License. You may add Your own attribution
 *           notices within Derivative Works that You distribute, alongside
 *           or as an addendum to the NOTICE text from the Work, provided
 *           that such additional attribution notices cannot be construed
 *           as modifying the License.
 *
 *       You may add Your own copyright statement to Your modifications and
 *       may provide additional or different license terms and conditions
 *       for use, reproduction, or distribution of Your modifications, or
 *       for any such Derivative Works as a whole, provided Your use,
 *       reproduction, and distribution of the Work otherwise complies with
 *       the conditions stated in this License.
 *
 *    5. Submission of Contributions. Unless You explicitly state otherwise,
 *       any Contribution intentionally submitted for inclusion in the Work
 *       by You to the Licensor shall be under the terms and conditions of
 *       this License, without any additional terms or conditions.
 *       Notwithstanding the above, nothing herein shall supersede or modify
 *       the terms of any separate license agreement you may have executed
 *       with Licensor regarding such Contributions.
 *
 *    6. Trademarks. This License does not grant permission to use the trade
 *       names, trademarks, service marks, or product names of the Licensor,
 *       except as required for reasonable and customary use in describing the
 *       origin of the Work and reproducing the content of the NOTICE file.
 *
 *    7. Disclaimer of Warranty. Unless required by applicable law or
 *       agreed to in writing, Licensor provides the Work (and each
 *       Contributor provides its Contributions) on an "AS IS" BASIS,
 *       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
 *       implied, including, without limitation, any warranties or conditions
 *       of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
 *       PARTICULAR PURPOSE. You are solely responsible for determining the
 *       appropriateness of using or redistributing the Work and assume any
 *       risks associated with Your exercise of permissions under this License.
 *
 *    8. Limitation of Liability. In no event and under no legal theory,
 *       whether in tort (including negligence), contract, or otherwise,
 *       unless required by applicable law (such as deliberate and grossly
 *       negligent acts) or agreed to in writing, shall any Contributor be
 *       liable to You for damages, including any direct, indirect, special,
 *       incidental, or consequential damages of any character arising as a
 *       result of this License or out of the use or inability to use the
 *       Work (including but not limited to damages for loss of goodwill,
 *       work stoppage, computer failure or malfunction, or any and all
 *       other commercial damages or losses), even if such Contributor
 *       has been advised of the possibility of such damages.
 *
 *    9. Accepting Warranty or Additional Liability. While redistributing
 *       the Work or Derivative Works thereof, You may choose to offer,
 *       and charge a fee for, acceptance of support, warranty, indemnity,
 *       or other liability obligations and/or rights consistent with this
 *       License. However, in accepting such obligations, You may act only
 *       on Your own behalf and on Your sole responsibility, not on behalf
 *       of any other Contributor, and only if You agree to indemnify,
 *       defend, and hold each Contributor harmless for any liability
 *       incurred by, or claims asserted against, such Contributor by reason
 *       of your accepting any such warranty or additional liability.
 *
 *    END OF TERMS AND CONDITIONS
 *
 *    APPENDIX: How to apply the Apache License to your work.
 *
 *       To apply the Apache License to your work, attach the following
 *       boilerplate notice, with the fields enclosed by brackets "{}"
 *       replaced with your own identifying information. (Don't include
 *       the brackets!)  The text should be enclosed in the appropriate
 *       comment syntax for the file format. We also recommend that a
 *       file or class name and description of purpose be included on the
 *       same "printed page" as the copyright notice for easier
 *       identification within third-party archives.
 *
 *    Copyright 2024 onsamepage.ai
 *
 *    Licensed under the Apache License, Version 2.0 (the "License");
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *        https://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an "AS IS" BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package ai.samepage.service.impl;

import ai.samepage.common.core.base.entity.BaseResponse;
import ai.samepage.common.core.exception.BusinessException;
import ai.samepage.common.core.helper.JTokkitHelper;
import ai.samepage.common.core.resp.RespCode;
import ai.samepage.common.core.util.JacksonUtils;
import ai.samepage.common.file.IS3Service;
import ai.samepage.config.S3Config;
import ai.samepage.config.SystemProperties;
import ai.samepage.config.WebConfig;
import ai.samepage.constant.Constants;
import ai.samepage.constant.MessageConstants;
import ai.samepage.entity.*;
import ai.samepage.llm.LlmGatewayService;
import ai.samepage.llm.exception.OpenAiHttpException;
import ai.samepage.llm.model.*;
import ai.samepage.mapper.ConversationInfoMapper;
import ai.samepage.model.MessageEnum;
import ai.samepage.model.command.ConversationInfoCommand;
import ai.samepage.model.command.ConversationMsgCommand;
import ai.samepage.model.command.UserInfoCommand;
import ai.samepage.model.convert.ConversationConvert;
import ai.samepage.model.dto.MsgDTO;
import ai.samepage.model.vo.ConversationInfoVO;
import ai.samepage.model.vo.MessageChatVO;
import ai.samepage.model.vo.TaskVO;
import ai.samepage.model.vo.UploadObjConfigVO;
import ai.samepage.openapi.IndexApiService;
import ai.samepage.openapi.QuestionRequestBody;
import ai.samepage.openapi.TextResponse;
import ai.samepage.service.*;
import ai.samepage.utils.MessageUtil;
import cn.hutool.core.collection.CollectionUtil;
import cn.hutool.core.util.IdUtil;
import cn.hutool.core.util.StrUtil;
import com.baomidou.mybatisplus.core.conditions.update.LambdaUpdateWrapper;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.fasterxml.jackson.annotation.JsonFormat;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import io.reactivex.rxjava3.core.Flowable;
import io.swagger.annotations.ApiModelProperty;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import javax.annotation.Resource;
import java.time.Duration;
import java.time.LocalDateTime;
import java.util.*;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.RejectedExecutionException;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicReference;
import java.util.function.Consumer;
import java.util.stream.Collectors;

import static ai.samepage.config.SessionUtil.getLocale;
import static ai.samepage.constant.MessageConstants.*;
import static ai.samepage.service.impl.DocumentInfoServiceImpl.CACHE_MAX_AGE;



@Service
@Slf4j
public class ConversationInfoServiceImpl extends ServiceImpl<ConversationInfoMapper, ConversationInfo> implements ConversationInfoService {

    @Resource
    private ConversationConvert conversationConvert;

    @Resource
    private DocumentInfoService documentInfoService;


    @Override
    public BaseResponse<ConversationInfoVO> list(Long userId, String docId, ChatModelEnum chatModelEnum, String keyword, Integer pageNo, Integer pageSize, String include) {
        Page<ConversationInfo> page = new Page<>(pageNo, pageSize, true);
        Long documentId = null;
        if (StrUtil.isNotBlank(docId)) {
            documentId = Long.parseLong(docId);
        }
        page = baseMapper.list(page, documentId, keyword, userId, chatModelEnum.name());
        List<ConversationInfo> records = page.getRecords();
        BaseResponse<ConversationInfoVO> response = new BaseResponse<>();
        response.setPageNo(pageNo);
        response.setTotal((int) page.getTotal());
        List<ConversationInfoVO> res = Lists.newArrayList();
        LocalDateTime now = LocalDateTime.now();
        Long id = StrUtil.isNotBlank(include) ? Long.parseLong(include) : null;
        if (Objects.nonNull(id)) {
            if (pageNo == 1) {
                ConversationInfo conversationInfo = baseMapper.get(id, keyword);
                if (Objects.nonNull(conversationInfo)) {
                    records.add(0, conversationInfo);
                } else {
                    log.warn("会话不存在{}", include);
                }
            }

        }
        List<Long> docIds = records.stream().map(ConversationInfo::getDocId).filter(Objects::nonNull).collect(Collectors.toList());
        Map<Long, DocumentInfo> cache = Collections.emptyMap();
        if (!docIds.isEmpty()) {

            List<DocumentInfo> docs = documentInfoService.list(Wrappers.lambdaQuery(DocumentInfo.class).in(DocumentInfo::getId, docIds));
            if (!docs.isEmpty()) {
                cache = Maps.newHashMap();
                for (DocumentInfo doc : docs) {
                    cache.put(doc.getId(), doc);
                }
            }
        }
        boolean isRemove = false;
        for (ConversationInfo record : records) {
            if (Objects.equals(record.getId(), id)) {
                if (isRemove) {
                    continue;
                } else {
                    isRemove = true;
                }
            }
            ConversationInfoVO conversationInfo = conversationConvert.toConversationInfo(record);
            conversationInfo.setIntervalMinute(String.valueOf(Duration.between(conversationInfo.getLastMessageTime(), now).toMinutes()));
            Long document = record.getDocId();
            if (Objects.nonNull(document)) {
                DocumentInfo info = cache.get(document);
                if (Objects.nonNull(info)) {
                    conversationInfo.setDocType(info.getDocType().getName());
                    conversationInfo.setName(info.getDocName());
                }
            }
            res.add(conversationInfo);
        }
        response.setRecords(res);
        // 如果是第一页就是 records 的size, 不是第一页，判断id 是否为空，如果不为空 加1
        response.setOtherTotal(pageNo == 1 ? response.getSize() : Objects.isNull(id) ? Math.min(pageNo * pageSize, response.getTotal()) : Math.min(pageNo * pageSize + 1, response.getTotal()));
        return response;
    }

    @Override
    public ConversationInfoVO updateInfo(ConversationInfoCommand command, Long userId) {
        String conversationId = command.getConversationId();
        long id = Long.parseLong(conversationId);
        ConversationInfo info = getOne(Wrappers.lambdaQuery(ConversationInfo.class).eq(ConversationInfo::getIsDeleted, false).eq(ConversationInfo::getId, id).eq(ConversationInfo::getCreateId, userId));
        if (Objects.isNull(info)) {
            throw new BusinessException(RespCode.NOT_FOUND, StrUtil.format("会话{}不存在", conversationId));
        }
        String title = command.getTitle();
        if (title.length() > Constants.CONV_TITLE_LENGTH) {
            title = title.substring(0, Constants.CONV_TITLE_LENGTH);
        }
        update(Wrappers.lambdaUpdate(ConversationInfo.class).eq(ConversationInfo::getIsDeleted, false)
                .eq(ConversationInfo::getId, id).eq(ConversationInfo::getCreateId, userId).set(ConversationInfo::getTitle, title)
                .set(ConversationInfo::getUpdateTime, LocalDateTime.now()));
        return getInfo(id, userId);
    }

    @Override
    public ConversationInfoVO getInfo(Long id, Long userId) {
        ConversationInfo info = get(id, userId);
        ConversationTypeEnum type = info.getType();
        if (Objects.equals(type, ConversationTypeEnum.DOC)) {
            // 判断文档是否存在
            DocumentInfo one = documentInfoService.getOne(Wrappers.lambdaQuery(DocumentInfo.class).eq(DocumentInfo::getId, info.getDocId()).eq(DocumentInfo::getIsDeleted, false));
            if (Objects.isNull(one)) {
                throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, "文档不存在");
            }
            ConversationInfoVO conversationInfo = conversationConvert.toConversationInfo(info);
            conversationInfo.setDocType(one.getDocType().getName());
            conversationInfo.setName(one.getDocName());
            conversationInfo.setDocId(String.valueOf(one.getId()));
            return conversationInfo;
        }

        return conversationConvert.toConversationInfo(info);
    }

    private ConversationInfo get(Long id, Long userId) {
        ConversationInfo info = getOne(Wrappers.lambdaUpdate(ConversationInfo.class).eq(ConversationInfo::getIsDeleted, false).eq(ConversationInfo::getId, id).eq(ConversationInfo::getCreateId, userId));
        if (Objects.isNull(info)) {
            throw new BusinessException(RespCode.NOT_FOUND, StrUtil.format("会话{}不存在", id));
        }
        return info;
    }


    @Resource
    private ConversationMessageService messageService;





    @Resource(name = "chatMessageTaskExecutor")
    private ExecutorService chatMessageTaskExecutor;


    @Resource
    private RedisTemplate<String, TaskVO> redisTemplate;


    @Override
    public String getRecentConversationId(Long userId, Long docId) {
        Long recentConversationId = baseMapper.getRecentConversationId(userId, docId);
        return Objects.isNull(recentConversationId) ? null : String.valueOf(recentConversationId);
    }


    /**
     * chat 信息
     *
     * @param conversationId   会话id
     * @param conversationInfo 会话基本信息
     * @param messageChat      message信息
     * @param message          消息回滚的信息
     * @param command          消息内容
     * @param userId           用户id
     * @param sId
     */

    private void chatNew(Long conversationId, ConversationInfo conversationInfo, ConversationMessage messageChat, DocumentTypeEnum documentType, Message message, ConversationMsgCommand command, Long userId, Locale locale, String sId) {
        DocumentInfo documentInfo = null;
        String documentId = null;
        ChatLanguageEnum language = ChatLanguageEnum.valueOf(command.getLanguage());
        try {
            // 1. 校验参数
            checkMessage(command);
            boolean isNew = false;
            if (Objects.isNull(conversationInfo)) {
                isNew = true;
            }
            messageChat.setContentType(ContentTypeEnum.reply_input);
            // 查询的documentId
            Long docId = null;
            String taskId = null;
            String parentMessageId = command.getParentMessageId();
            ChatModelEnum model = ChatModelEnum.getChatModelEnum(command.getModel());
            String content = null;
            // 2. 创建会话或者获取会话的基本信息
            List<ConversationMsgCommand.MessageInfoCommand> messages = command.getMessages();
            // 判断是否重试
            AtomicBoolean isRetry = new AtomicBoolean(true);
            if (!messages.isEmpty()) {
                conversationInfo = messageService.saveMessage(command, userId, conversationId, isRetry);
                ConversationMsgCommand.MessageInfoCommand messageInfoCommand = messages.get(messages.size() - 1);
                taskId = messageInfoCommand.getTaskId();
                parentMessageId = messageInfoCommand.getMessageId();
                messageChat.setIntentId(messageInfoCommand.getIntentId());
                content = messageInfoCommand.getContent();
                String dId = messageInfoCommand.getDocId();
                if (StrUtil.isNotBlank(dId)) {
                    docId = Long.parseLong(dId);
                }
            }
            preSave(messageChat, parentMessageId, model);
            if (isRetry.get() || messages.isEmpty()) {
                RetryConfig retry = retry(parentMessageId, conversationInfo, messageChat, message);
                docId = null;
                if (StrUtil.isBlank(content)) {
                    content = retry.getContent();
                }
                documentId = retry.getDocumentId();
                taskId = null;
            } else {
                ConversationTypeEnum type = conversationInfo.getType();
                messageChat.setContentType(ContentTypeEnum.text);
                message.setContentType(ContentTypeEnum.text);
                if (isNew) {
                    if (type == ConversationTypeEnum.CHAT_INDEX || type == ConversationTypeEnum.DOC) {
                        messageChat.setContentType(ContentTypeEnum.reply_summary);
                        message.setContentType(ContentTypeEnum.reply_summary);
                    }
                } else {
                    if (messages.size() == 1) {
                        if (type == ConversationTypeEnum.CHAT_INDEX) {
                            messageChat.setContentType(ContentTypeEnum.reply_source);
                            message.setContentType(ContentTypeEnum.reply_source);
                        } else if (type == ConversationTypeEnum.DOC) {
                            messageChat.setContentType(ContentTypeEnum.reply_doc_source);
                            message.setContentType(ContentTypeEnum.reply_doc_source);
                        }
                    }
                }

            }

            documentInfo = handler(messageChat, message, content, documentId, documentType, taskId, docId, conversationInfo, language, locale, sId, command.getWebSearch());
            MessageEnum status = messageChat.getStatus();
            if (Objects.isNull(status) || Objects.equals(status, MessageEnum.RUNNING)) {
                messageChat.setStatus(MessageEnum.SUCCESS);
            }
        } catch (Exception e) {
            try {
                log.error(StrUtil.format("请求：{}，\n出现错误:{}", JacksonUtils.writeValueAsString(command), e.getMessage()), e);
            } catch (Exception exception) {
                // do nothing
            }
            MessageEnum mess = MessageEnum.getMessage(ERROR_MESSAGE_TYPE, language);
            if (Objects.isNull(mess)) {
                mess = MessageEnum.SERVER_ERROR_CHINESE;
            }
            messageChat.setContent(e.getMessage());
            messageChat.setContentType(ContentTypeEnum.text);
            messageChat.setStatus(mess);
            message.setStatus(MESSAGE_FAILED_STATUS);
            message.setContent(mess.getDesc());
            message.setContentType(ContentTypeEnum.text);
            msgSseEmitterService.send(sId, message);
        } finally {
            saveMessageResponse(messageChat, documentInfo, sId);
            closeSse(sId);
        }


    }

    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    private static class RetryConfig {


        /**
         * 最后的问题
         */
        private String content;

        /**
         * 文档的id,langchain 服务的
         */
        private String documentId;

        /**
         * 内部的文档id
         */
        private Long docId;

    }

    /**
     * 重试 执行逻辑
     *
     * @param parentMessageId
     * @param conversationInfo
     * @param messageChat
     * @param message
     * @return
     */
    private RetryConfig retry(String parentMessageId, ConversationInfo conversationInfo, ConversationMessage messageChat, Message message) {
        // 3. 重试的操作逻辑（不需要进行审核）
        if (StrUtil.isBlank(parentMessageId)) {
            throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, "换个问题的父messageId为空");
        }
        // 获取parentId
        ConversationTypeEnum type = conversationInfo.getType();
        ConversationMessage one = messageService.getOne(Wrappers.lambdaQuery(ConversationMessage.class).eq(ConversationMessage::getMessageId, parentMessageId).eq(ConversationMessage::getConversationId, messageChat.getConversationId()));
        ContentTypeEnum contentType = one.getContentType();

        String content = one.getContent();
        String documentId = null;
        Long docId = null;
        switch (type) {
            case DOC:
            case CHAT_INDEX:
                switch (contentType) {
                    case read_doc:
                    case read_article:
                        messageChat.setContentType(ContentTypeEnum.reply_summary);
                        message.setContentType(ContentTypeEnum.reply_summary);
                        documentId = one.getContent();
                        break;
                    case intent:
                        messageChat.setIntentId(one.getIntentId());
                        messageChat.setContentType(ContentTypeEnum.text);
                        message.setContentType(ContentTypeEnum.text);
                        break;
                    default:
                        if (Objects.equals(type, ConversationTypeEnum.DOC)) {
                            messageChat.setContentType(ContentTypeEnum.reply_doc_source);
                            message.setContentType(ContentTypeEnum.reply_doc_source);
                            docId = conversationInfo.getDocId();
                        } else {
                            messageChat.setContentType(ContentTypeEnum.reply_source);
                            message.setContentType(ContentTypeEnum.reply_source);
                        }
                        break;
                }
                break;
            case COMMON:
            default:
                messageChat.setContentType(ContentTypeEnum.text);
                message.setContentType(ContentTypeEnum.text);
                break;
        }
        return new RetryConfig(content, documentId, docId);
    }

    /**
     * 预保存
     *
     * @param messageChat
     * @param parentMessageId
     * @param model
     */
    private void preSave(ConversationMessage messageChat, String parentMessageId, ChatModelEnum model) {
        messageChat.setParentId(parentMessageId);
        messageChat.setContent(MESSAGE_RUNNING);
        messageChat.setRole(ChatRoleEnum.assistant);
        messageChat.setCreateTime(LocalDateTime.now());
        messageChat.setModel(getModelName(model));
        messageChat.setStatus(MessageEnum.RUNNING);
        messageChat.setLike(MessageLikeEnum.unknown.name());
        messageService.save(messageChat);
    }


    /**
     * @param model bot key
     * @return 调用模型名
     */
    private String getModelName(ChatModelEnum model) {
        switch (model) {
            case chat_pro:
                return systemProperties.getChatProModelName();
            case chat_lite:
                return systemProperties.getChatLiteModelName();
            default:
                throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, StrUtil.format("暂不支持该bot:{}", model));
        }
    }


    @Resource
    private DocumentSummaryService documentSummaryService;

    @Resource
    private TaskService taskService;

    @Resource
    private RateLimiterService rateLimiterService;

    /**
     * 获取令牌
     *
     * @param messageChat
     * @param language
     * @param message
     * @param model
     * @return
     */
    private Boolean getLimiter(ConversationMessage messageChat, ChatLanguageEnum language,
                               Message message, ChatModelEnum model, String sseKey) {

        if (!rateLimiterService.tryAcquire(model.getName())) {
            MessageEnum mess = MessageEnum.getMessage(EXCEED_MESSAGE_TYPE, language);
            if (Objects.isNull(mess)) {
                mess = MessageEnum.LIMITED_ERROR_CHINESE;
            }
            messageChat.setContent(mess.getDesc());
            messageChat.setContentType(ContentTypeEnum.text);
            messageChat.setStatus(mess);
            message.setStatus(MESSAGE_FAILED_STATUS);
            message.setContent(mess.getDesc());
            message.setContentType(ContentTypeEnum.text);
            msgSseEmitterService.send(sseKey, message);
            return false;
        }
        return true;
    }

    private DocumentInfo handler(ConversationMessage messageChat, Message message, String content, String documentId, DocumentTypeEnum documentType, String taskId, Long docId, ConversationInfo conversationInfo, ChatLanguageEnum language, Locale locale, String sseKey, String webSearch) {
        DocumentInfo documentInfo = null;
        ContentTypeEnum contentType = messageChat.getContentType();
        Locale langLocale = language.getLocale();
        if (Objects.isNull(langLocale)) {
            langLocale = locale;
        }
        String lang = langLocale.getDisplayLanguage(Locale.ENGLISH);
        ChatModelEnum chatModel = ChatModelEnum.getChatModelEnum(conversationInfo.getModel());
        String modelName = getModelName(chatModel);
        switch (contentType) {
            case reply_summary:
                if (Objects.nonNull(docId)) {
                    // copy 缓存的信息，如果没有这个语言 则重新生成
                    documentInfo = documentInfoService.getOne(Wrappers.lambdaQuery(DocumentInfo.class).eq(DocumentInfo::getId, docId).eq(DocumentInfo::getIsDeleted, false));
                    if (Objects.isNull(documentInfo)) {
                        throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, StrUtil.format("文件{}不存在", docId));
                    }
                    documentId = documentInfo.getDocumentId();
                    DocumentSummary documentSummary = documentSummaryService.getOne(Wrappers.lambdaQuery(DocumentSummary.class).eq(DocumentSummary::getDocumentId, documentId).eq(DocumentSummary::getLanguage, lang));
                    if (Objects.nonNull(documentSummary)) {
                        String summary = documentSummary.getSummary();
                        messageChat.setContent(summary);
                        Integer status = documentSummary.getStatus();
                        messageChat.setStatus(MessageEnum.getMessage(status));
                        message.setContent(summary);
                        message.setStatus(MessageEnum.getMessage(status).getType());
                        msgSseEmitterService.send(sseKey, message);
                        message.setFinished(MESSAGE_SUMMARY_DONE);
                        msgSseEmitterService.send(sseKey, message);
                        String questions = documentSummary.getQuestions();
                        messageChat.setSuggest(questions);
                        List<MessageChatVO.TextVO> textList = JacksonUtils.readValueAsList(questions, MessageChatVO.TextVO.class);
                        for (MessageChatVO.TextVO textVO : textList) {
                            message.setSuggest(textVO);
                            msgSseEmitterService.send(sseKey, message);
                        }
                        return documentInfo;
                    }
                }
                // 获取任务信息
                StringBuilder contentStr = new StringBuilder();
                StringBuilder questionStr = new StringBuilder();
                AtomicInteger index = new AtomicInteger(1);
                AtomicBoolean isError = new AtomicBoolean(false);
                Consumer<TextResponse> consumer = k -> {
                    String t = k.getType();
                    Boolean done = k.getDone();
                    String text = k.getContent();
                    switch (t) {
                        case SAVE_DOCUMENT_KEY:
                            MessageEnum status = k.getStatus();
                            if (Objects.nonNull(status)) {
                                message.setStatus(status.getType());
                                messageChat.setStatus(status);
                                msgSseEmitterService.send(sseKey, message);
                            }
                            break;
                        case SUMMARY_KEY:
                            if (Objects.equals(done, true)) {
                                message.setContent(text);
                                message.setFinished(MESSAGE_SUMMARY_DONE);
                                msgSseEmitterService.send(sseKey, message);
                            } else {
                                if (Objects.nonNull(text)) {
                                    contentStr.append(text);
                                    message.setContent(text);
                                    msgSseEmitterService.send(sseKey, message);
                                }
                            }
                            break;
                        case ERROR_KEY:
                            isError.set(true);
                            MessageEnum messageEnum = MessageEnum.getMessage(ERROR_MESSAGE_TYPE, language);
                            if (Objects.isNull(messageEnum)) {
                                messageEnum = MessageEnum.SERVER_ERROR_CHINESE;
                            }
                            message.setStatus(MESSAGE_FAILED_STATUS);
                            message.setContent(messageEnum.getDesc());
                            messageChat.setContent(text);
                            messageChat.setStatus(messageEnum);
                            msgSseEmitterService.send(sseKey, message);
                            break;
                        case QUESTION_KEY:
                            if (Objects.nonNull(text)) {
                                questionStr.append(text);
                                int key = index.get();
                                if (key > 3) {
                                    break;
                                }
                                String[] split = text.split("\n");
                                int length = split.length;

                                MessageChatVO.TextVO textVO = new MessageChatVO.TextVO();
                                textVO.setKey(String.valueOf(key));
                                for (int i = 0; i < length; i++) {
                                    // 当是第一个时，追加到之前那个
                                    String s = split[i];
                                    if (Objects.isNull(s) || "".equals(s)) {
                                        continue;
                                    }
                                    if (i > 0) {
                                        textVO.setKey(String.valueOf(index.incrementAndGet()));
                                    }
                                    textVO.setText(s);
                                    message.setSuggest(textVO);
                                    msgSseEmitterService.send(sseKey, message);
                                }
                                // 如果是以"\n" 结尾 不会split 一个新的元素
                                if (text.endsWith("\n")) {
                                    index.incrementAndGet();
                                }
                            }
                            break;
                        default:
                            break;
                    }
                };
                if (StrUtil.isNotBlank(taskId)) {
                    documentInfo = taskService.getResult(taskId, messageChat, consumer, taskInfo -> {
                        if (Objects.nonNull(taskInfo)) {
                            String pdfDocId = taskInfo.getDocId();
                            String pdfDocumentId = taskInfo.getDocumentId();
                            if (StrUtil.isNotBlank(pdfDocId)) {
                                update(Wrappers.lambdaUpdate(ConversationInfo.class).eq(ConversationInfo::getId, conversationInfo.getId()).eq(ConversationInfo::getIsDeleted, false).set(ConversationInfo::getDocId, Long.parseLong(pdfDocId)));
                            }
                            if (StrUtil.isNotBlank(pdfDocumentId)) {
                                messageService.update(Wrappers.lambdaUpdate(ConversationMessage.class).eq(ConversationMessage::getConversationId, conversationInfo.getId()).in(ConversationMessage::getContentType, Arrays.asList(ContentTypeEnum.read_article.getCode(), ContentTypeEnum.read_doc.getCode())).set(ConversationMessage::getContent, pdfDocumentId));
                            }
                        }
                    });

                }
                if (StrUtil.isNotBlank(documentId)) {
                    // 换个答案
                    indexApiService.retryDocument(documentId, lang, documentType, consumer);
                }
                if (!isError.get()) {
                    if (contentStr.length() > 0) {
                        messageChat.setContent(contentStr.toString());
                        log.info("获取到的提问的问题：{}", questionStr);
                        List<String> text = StrUtil.split(questionStr, "\n");
                        int size = Math.min(text.size(), 3);
                        List<MessageChatVO.TextVO> textList = Lists.newArrayList();
                        for (int i = 0; i < size; i++) {
                            textList.add(new MessageChatVO.TextVO(String.valueOf(i + 1), text.get(i)));
                        }
                        messageChat.setSuggest(JacksonUtils.writeValueAsString(textList));
                    }

                }
                break;
            case reply_source:
            case reply_doc_source:
                // 获取之前的信息
                if (getLimiter(messageChat, language, message, ChatModelEnum.chat_lite, sseKey)) {
                    String question = getQuestion(messageChat, content, locale);
                    // 获取documentId
                    ConversationMessage one = messageService.getOne(Wrappers.lambdaQuery(ConversationMessage.class).eq(ConversationMessage::getConversationId, messageChat.getConversationId()).in(ConversationMessage::getContentType, Arrays.asList(ContentTypeEnum.read_article.getCode(), ContentTypeEnum.read_doc.getCode())));
                    if (Objects.isNull(one)) {
                        throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, "获取不到document的唯一标识");
                    }
                    documentId = one.getContent();
                    if (StrUtil.isBlank(documentId)) {
                        throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, "获取不到document的唯一标识");
                    }
                    StringBuilder sb = new StringBuilder();
                    AtomicBoolean error = new AtomicBoolean(false);
                    List<MessageChatVO.TextVO> textList = Lists.newArrayList();
                    indexApiService.questionDoc(documentId, lang, modelName, question, documentType, k -> {
                        String t = k.getType();
                        String text = k.getContent();
                        switch (t) {
                            case ERROR_KEY:
                                error.set(true);
                                MessageEnum messageEnum = MessageEnum.getMessage(ERROR_MESSAGE_TYPE, language);
                                if (Objects.isNull(messageEnum)) {
                                    messageEnum = MessageEnum.SERVER_ERROR_CHINESE;
                                }
                                message.setStatus(MESSAGE_FAILED_STATUS);
                                message.setContent(messageEnum.getDesc());
                                messageChat.setStatus(messageEnum);
                                msgSseEmitterService.send(sseKey, message);
                                break;
                            case SOURCE_KEY:
                                textList.addAll(JacksonUtils.readValueAsList(text, MessageChatVO.TextVO.class));
                                break;
                            case ANSWER_KEY:
                                if (Objects.nonNull(text)) {
                                    sb.append(text);
                                    message.setContent(text);
                                    msgSseEmitterService.send(sseKey, message);
                                }
                                break;
                            default:
                                break;
                        }
                    });
                    if (!error.get()) {
                        messageChat.setContent(sb.toString());
                        if (!textList.isEmpty()) {
                            int size = textList.size();
                            for (int i = 0; i < size; i++) {
                                MessageChatVO.TextVO textVO = textList.get(i);
                                textVO.setKey(String.valueOf(i + 1));
                                message.setReference(textVO);
                                log.info("来源信息：{}", textVO);
                                msgSseEmitterService.send(sseKey, message);
                            }
                        }
                        messageChat.setReference(JacksonUtils.writeValueAsString(textList));
                    }
                } else {
                    MessageEnum mess = MessageEnum.getMessage(EXCEED_MESSAGE_TYPE, language);
                    if (Objects.isNull(mess)) {
                        mess = MessageEnum.LIMITED_ERROR_CHINESE;
                    }
                    message.setStatus(MESSAGE_FAILED_STATUS);
                    message.setContent(mess.getDesc());
                    messageChat.setContent(mess.getDesc());
                    messageChat.setStatus(mess);
                    msgSseEmitterService.send(sseKey, message);
                }
                break;
            case input:
            case text:
            default:
                message.setContentType(ContentTypeEnum.reply_input);
                messageChat.setContentType(ContentTypeEnum.reply_input);
                List<ConversationMessage> messageList;
                String intentId = messageChat.getIntentId();
                if (StrUtil.isNotBlank(intentId)) {
                    log.info("快捷操作id:{}", messageChat.getIntentId());
                    // 快捷操作
                    messageList = messageService.list(Wrappers.lambdaQuery(ConversationMessage.class).eq(ConversationMessage::getContentType, ContentTypeEnum.intent.getCode()).eq(ConversationMessage::getIntentId, intentId).eq(ConversationMessage::getConversationId, messageChat.getConversationId()));
                } else {
                    messageList = messageService.list(Wrappers.lambdaQuery(ConversationMessage.class)
                            .ne(ConversationMessage::getContentType, ContentTypeEnum.welcome.getCode())
                            .ne(ConversationMessage::getContentType, ContentTypeEnum.virtual_root.getCode())
                            .eq(ConversationMessage::getConversationId, messageChat.getConversationId()));
                }
                if (getLimiter(messageChat, language, message, chatModel, sseKey)) {
                    request(messageList, chatModel, messageChat.getParentId(), language, locale, messageChat, message, sseKey, webSearch);
                } else {
                    MessageEnum mess = MessageEnum.getMessage(EXCEED_MESSAGE_TYPE, language);
                    if (Objects.isNull(mess)) {
                        mess = MessageEnum.LIMITED_ERROR_CHINESE;
                    }
                    message.setStatus(MESSAGE_FAILED_STATUS);
                    message.setContent(mess.getDesc());
                    messageChat.setContent(mess.getDesc());
                    messageChat.setStatus(mess);
                    msgSseEmitterService.send(sseKey, message);
                }
                break;

        }
        return documentInfo;
    }


    @Resource
    private SseEmitterService<Message> msgSseEmitterService;

    @Override
    public SseEmitter message(ConversationMsgCommand command, Long userId, String locale) {
        // 校验参数
        Long conversationId = null;
        String messageId = IdUtil.fastUUID();
        String conversationIdStr = command.getConversationId();
        ConversationInfo info;
        DocumentTypeEnum documentType = null;
        ChatLanguageEnum language = ChatLanguageEnum.valueOf(command.getLanguage());
        Locale languageLocale = language.getLocale();
        if (Objects.isNull(languageLocale)) {
            languageLocale = getLocale(locale);
        }
        if (StrUtil.isBlank(conversationIdStr)) {
            info = null;
            conversationId = IdUtil.getSnowflakeNextId();
        } else {
            conversationId = Long.parseLong(conversationIdStr);
            info = get(conversationId, userId);
            if (Objects.equals(info.getType(), ConversationTypeEnum.DOC)) {
                Long id = info.getDocId();
                DocumentInfo one = documentInfoService.getOne(Wrappers.lambdaQuery(DocumentInfo.class).eq(DocumentInfo::getId, id).eq(DocumentInfo::getIsDeleted, false));
                if (Objects.isNull(one)) {
                    throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, StrUtil.format("会话{}的文档{}不存在", conversationId, id));
                }
                documentType = one.getDocType();
            }

        }
        String sId = msgSseEmitterService.createSseEmitter(userId, conversationId, messageId);
        //保存message
        String parentMessageId = command.getParentMessageId();
        List<ConversationMsgCommand.MessageInfoCommand> messages = command.getMessages();
        if (CollectionUtil.isNotEmpty(messages)) {
            parentMessageId = messages.get(messages.size() - 1).getMessageId();
        }
        // 异步执行
        LocalDateTime now = LocalDateTime.now();
        ConversationMessage messageChat = new ConversationMessage();
        messageChat.setConversationId(conversationId);
        messageChat.setParentId(parentMessageId);
        messageChat.setMessageId(messageId);
        messageChat.setType(MessageTypeEnum.text);
        messageChat.setCreateId(userId);
        messageChat.setLike(MessageLikeEnum.unknown.name());
        //messageChat.setContentType(contentType);
        messageChat.setStatus(MessageEnum.RUNNING);
        Message message = new Message();
        message.setMessageId(messageChat.getMessageId());
        message.setParentMessageId(messageChat.getParentId());
        message.setCreateId(messageChat.getCreateId());
        message.setCreateTime(now);
        messageChat.setCreateTime(now);
        message.setRole(ChatRoleEnum.assistant);
        message.setContentType(messageChat.getContentType());
        message.setType(MessageTypeEnum.text);
        message.setStatus(MESSAGE_SUCCESS_STATUS);
        message.setConnectId(sId);
        //message.setContentType(ContentTypeEnum.text);
        message.setConversationId(String.valueOf(messageChat.getConversationId()));
        Long finalConversationId = conversationId;
        msgSseEmitterService.send(sId, message);
        try {
            DocumentTypeEnum documentTypeEnum = documentType;
            Locale local = languageLocale;
            chatMessageTaskExecutor.execute(() -> this.chatNew(finalConversationId, info, messageChat, documentTypeEnum, message, command, userId, local, sId));
        } catch (RejectedExecutionException rej) {
            try {
                log.error(StrUtil.format("请求：{}，\n出现错误:{}", JacksonUtils.writeValueAsString(command), rej.getMessage()), rej);
            } catch (Exception exception) {
                // do nothing
            }
            messageChat.setContent(rej.getMessage());
            MessageEnum mess = MessageEnum.getMessage(EXCEED_MESSAGE_TYPE, language);
            if (Objects.isNull(mess)) {
                mess = MessageEnum.LIMITED_ERROR_CHINESE;
            }
            messageChat.setStatus(mess);
            message.setContent(mess.getDesc());
            message.setContentType(ContentTypeEnum.text);
            message.setStatus(MESSAGE_FAILED_STATUS);
            msgSseEmitterService.send(sId, message);
            closeSse(sId);
        }
        return msgSseEmitterService.getSseEmitter(sId);
    }

    /**
     * 校验并判断信息
     *
     * @param command
     */
    private void checkMessage(ConversationMsgCommand command) {
        // 如果 parentMessageId和messages 列表都为空开始报错
        List<ConversationMsgCommand.MessageInfoCommand> messages = command.getMessages();
        if (StrUtil.isBlank(command.getParentMessageId()) && (Objects.isNull(messages) || messages.isEmpty())) {
            throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, "父的messageId和message 列表都不能为空");
        }

        if (CollectionUtil.isNotEmpty(messages)) {
            LocalDateTime now = LocalDateTime.now();
            for (ConversationMsgCommand.MessageInfoCommand message : messages) {
                if (StrUtil.isBlank(message.getContent()) && StrUtil.isBlank(message.getTaskId()) && StrUtil.isBlank(message.getDocId())) {
                    throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, "消息体不能为空");
                }
                String parentMessageId = message.getParentMessageId();
                String conversationId = message.getConversationId();
                if (StrUtil.isNotBlank(conversationId) && StrUtil.isBlank(parentMessageId)) {
                    throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, "存在没有父的messageId 的消息");
                }
                message.setCreateTime(now);
            }
        }
    }

    @Resource
    private SystemProperties systemProperties;


    private static final String LIMIT_KEY = "chat:message:{}";


    /**
     * 获取最大的请求 token数
     *
     * @param chatModel bot key
     * @return
     */
    private Integer getMaxRequestToken(ChatModelEnum chatModel) {
        switch (chatModel) {
            case chat_lite:
                return systemProperties.getChatLiteMaxToken();
            case chat_pro:
                return systemProperties.getChatProMaxToken();
            default:
                throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, StrUtil.format("获取不到bot{} 最大的请求token 数", chatModel));
        }
    }


    private void request(List<ConversationMessage> messages, ChatModelEnum modelEnum, String parentMessageId, ChatLanguageEnum language, Locale locale, ConversationMessage messageChat, Message message, String sseKey, String webSearch) {
        Map<String, ConversationMessage> cache = messages.stream().collect(Collectors.toMap(ConversationMessage::getMessageId, k -> k));
        ConversationMessage conversationMessage = cache.get(parentMessageId);
        boolean isNotWebSearch = StrUtil.isBlank(webSearch) || Objects.equals("NONE", webSearch.toUpperCase());
        StringBuilder sb = new StringBuilder();
        String modelName = getModelName(modelEnum);
        Integer requestToken = getMaxRequestToken(modelEnum);
        List<ChatMessage> chatMessages = Lists.newArrayList();
        if (isNotWebSearch) {
            List<String> prompts = systemProperties.getSystemPrompt(language);
            if (CollectionUtil.isNotEmpty(prompts)) {
                for (String prompt : prompts) {
                    if (StrUtil.isNotBlank(prompt)) {
                        chatMessages.add(new ChatMessage(ChatMessageRole.SYSTEM.value(), prompt));
                        sb.append(prompt);
                    }
                }
            }
        }
        Stack<ChatMessage> stack = new Stack<>();
        int tokens = 0;
        Boolean isQuestion = null;
        AtomicReference<String> softReference = new AtomicReference<>();
        while (Objects.nonNull(conversationMessage)) {
            MessageEnum status = conversationMessage.getStatus();
            if (Objects.equals(status, MessageEnum.SUCCESS)) {
                // 开始进行token 计算
                String mess = conversationMessage.getContent();
                if (StrUtil.isBlank(mess)) {
                    mess = conversationMessage.getLongContent();
                }
                switch (conversationMessage.getContentType()) {
                    case reply_input:
                    case input:
                    case web_search:
                        mess = MessageUtil.getContent(conversationMessage);
                        mess = mess.substring(0, Math.min(mess.length(), requestToken));
                        conversationMessage.setContentType(ContentTypeEnum.text);
                        conversationMessage.setContent(mess);
                        break;
                }
                if (isNotWebSearch) {
                    tokens = JTokkitHelper.countTokens(mess + sb, modelName);
                    if (tokens > requestToken) {
                        // 判断是不是和parentMessage 一样
                        if (Objects.equals(parentMessageId, conversationMessage.getMessageId()) || Objects.equals(conversationMessage.getMessageId(), conversationMessage.getIntentId())) {
                            conversationMessage.setContent(mess.substring(0, mess.length() - Math.max((tokens - requestToken) / 4, 10)));
                            continue;
                        }
                        break;

                    }
                    sb.append(mess);
                }
                if (Objects.isNull(isQuestion)) {
                    isQuestion = true;
                } else if (!Objects.equals(ContentTypeEnum.intent, conversationMessage.getContentType())) {
                    isQuestion = false;
                }
                ChatMessage chatMessage = toChatMessage(conversationMessage, locale, isQuestion, softReference);
                if (Objects.nonNull(chatMessage)) {
                    stack.push(chatMessage);
                }

            }
            conversationMessage = cache.get(conversationMessage.getParentId());
        }
        messageChat.setRequestToken(tokens);
        messageChat.setModel(modelName);


        while (!stack.isEmpty()) {
            chatMessages.add(stack.pop());
        }

        msgSseEmitterService.send(sseKey, message);
        if (isNotWebSearch) {
            openaiRequest(language, messageChat, chatMessages, message, modelEnum, sseKey);
        } else {
            webSearch(language, messageChat, chatMessages, message, modelName, sseKey, webSearch);
        }


    }

    private void webSearch(ChatLanguageEnum language, ConversationMessage messageChat, List<ChatMessage> chatMessages, Message message, String modelName, String sseKey, String webSearch) {
        AtomicBoolean isError = new AtomicBoolean(false);
        // 联网检索提供的问题
        StringBuilder question = new StringBuilder();
        // 回答信息
        StringBuilder sb = new StringBuilder();
        List<MessageChatVO.TextVO> refer = Lists.newArrayList();
        message.setContentType(ContentTypeEnum.reply_input);
        messageChat.setContentType(ContentTypeEnum.reply_input);
        Consumer<TextResponse> consumer = textResponse -> {
            String type = textResponse.getType();
            String text = textResponse.getContent();
            switch (type) {
                case ERROR_KEY:
                    isError.set(true);
                    MessageEnum messageEnum = MessageEnum.getMessage(ERROR_MESSAGE_TYPE, language);
                    if (Objects.isNull(messageEnum)) {
                        messageEnum = MessageEnum.SERVER_ERROR_CHINESE;
                    }
                    message.setStatus(MESSAGE_FAILED_STATUS);
                    message.setContent(messageEnum.getDesc());
                    messageChat.setContent("调用ai-service 失败：" + text);
                    messageChat.setStatus(messageEnum);
                    msgSseEmitterService.send(sseKey, message);
                    break;
                case WEB_SEARCH_INPUT:
                    // 回复的事问题
                    message.setContentType(ContentTypeEnum.web_search);
                    messageChat.setContentType(ContentTypeEnum.web_search);
                    if (Objects.nonNull(text)) {
                        question.append(text);
                        message.setQuestion(text);
                        msgSseEmitterService.send(sseKey, message);
                    }
                    break;
                case WEB_SEARCH_RESULT:
                    message.setContentType(ContentTypeEnum.web_search);
                    messageChat.setContentType(ContentTypeEnum.web_search);
                    if (StrUtil.isNotBlank(text)) {
                        List<Map> maps = JacksonUtils.readValueAsList(text, Map.class);
                        int size = maps.size();
                        for (int i = 0; i < size; i++) {
                            Map map = maps.get(i);
                            MessageChatVO.TextVO textVO = new MessageChatVO.TextVO();
                            textVO.setKey(String.valueOf(i + 1));
                            Object value = map.get("snippet");
                            if (Objects.nonNull(value)) {
                                textVO.setText(String.valueOf(value));
                            }
                            value = map.get("title");
                            if (Objects.nonNull(value)) {
                                textVO.setTitle(String.valueOf(value));
                            }
                            value = map.get("link");
                            if (Objects.nonNull(value)) {
                                textVO.setLink(String.valueOf(value));
                            }
                            refer.add(textVO);
                            message.setReference(textVO);
                            msgSseEmitterService.send(sseKey, message);
                        }
                    }
                    break;
                case ANSWER_KEY:
                    if (Objects.nonNull(text)) {
                        sb.append(text);
                        message.text(text);
                        msgSseEmitterService.send(sseKey, message);
                    }
                    break;
                default:
                    break;
            }
        };
        int index = chatMessages.size() - 1;
        ChatMessage chatMessage = chatMessages.get(index);
        chatMessages.remove(index);
        QuestionRequestBody requestBody = new QuestionRequestBody();
        requestBody.setLang(language.name().toLowerCase());
        requestBody.setQuestion(chatMessage.getContent());
        requestBody.setWebSearch(webSearch.toLowerCase());
        List<QuestionRequestBody.HistoryDTO> history = Collections.emptyList();
        if (!chatMessages.isEmpty()) {
            history = Lists.newArrayList();
            for (ChatMessage msg : chatMessages) {
                history.add(new QuestionRequestBody.HistoryDTO(msg.getRole(), msg.getContent()));
            }
        }
        requestBody.setChatModel(modelName);
        requestBody.setHistory(history);
        indexApiService.chat(requestBody, consumer);
        if (!isError.get()) {
            if (!refer.isEmpty()) {
                messageChat.setReference(JacksonUtils.writeValueAsString(refer));
            }
            if (question.length() > 0) {
                messageChat.setQuestion(question.toString());
            }
            MessageUtil.builderContent(messageChat, MsgDTO.text(sb.toString()));
        }
    }

    /**
     * 直接调用模型信息
     *
     * @param language     语言
     * @param messageChat  问题的基本信息
     * @param chatMessages 历史记录
     * @param message      返回的message
     * @param chatModel    模型信息
     * @param sseKey       sse 的key
     */
    private void openaiRequest(ChatLanguageEnum language, ConversationMessage messageChat, List<ChatMessage> chatMessages, Message message, ChatModelEnum chatModel, String sseKey) {
        try {
            StringBuilder contentCache = new StringBuilder();
            ChatCompletionRequest.ChatCompletionRequestBuilder builder = ChatCompletionRequest.builder();
            if (Objects.nonNull(systemProperties.getTemperature())) {
                builder.temperature(systemProperties.getTemperature());
            }
            Double top = systemProperties.getTop();
            if (Objects.nonNull(top)) {
                builder.topP(top);
            }
            String prompt = language.getPrompt();
            if (StrUtil.isNotBlank(prompt)) {
                chatMessages.add(new ChatMessage(ChatMessageRole.USER.value(), prompt));
            }
            String modelName = getModelName(chatModel);
            builder.model(modelName).messages(chatMessages);
            Flowable<CompletionChunk> chatCompletionChunkFlowable = null;
            if (log.isInfoEnabled()) {
                log.info("传递参数的信息：{}", chatMessages);
            }
            chatCompletionChunkFlowable = openAIService.streamChatCompletion(builder.build());
            for (CompletionChunk chunk : chatCompletionChunkFlowable.blockingIterable()) {
                List<CompletionChunk.CompletionChoice> choices = chunk.getChoices();
                if (Objects.isNull(choices) || choices.isEmpty()) {
                    continue;
                }
                CompletionChunk.CompletionChoice chatCompletionChoice = choices.get(0);
                if (Objects.nonNull(chatCompletionChoice)) {
                    String finishReason = chatCompletionChoice.getFinishReason();
                    CompletionChunk.ChatMessage message1 = chatCompletionChoice.getMessage();
                    if (StrUtil.isNotBlank(finishReason)) {
                        if (Objects.equals(finishReason.toLowerCase(), "stop")) {
                            break;
                        }
                        if (Objects.equals(finishReason.toLowerCase(), "length")) {
                            // 超过 token值
                            contentCache.append(language.getExceedTokenError());
                            message.text(language.getExceedTokenError());
                            msgSseEmitterService.send(sseKey, message);
                            break;
                        }
                    }
                    if (Objects.nonNull(message1)) {
                        String content1 = message1.getContent();
                        if (Objects.nonNull(content1)) {
                            contentCache.append(content1);
                            message.text(content1);
                            msgSseEmitterService.send(sseKey, message);
                        }
                    }
                }
            }
            MessageUtil.builderContent(messageChat, MsgDTO.text(contentCache.toString()));
            // 计算返回的 token数
            messageChat.setResponseToken(JTokkitHelper.countTokens(contentCache.toString(), modelName));
        } catch (Exception httpException) {
            log.error(httpException.getMessage(), httpException);
            throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, StrUtil.format("调用openai报错：{}", httpException.getMessage()));
        }

    }


    @Resource
    private WebConfig webConfig;


    private String getQuestion(ConversationMessage messageChat, String question, Locale locale) {
        List<ConversationMessage> messages = messageService.list(Wrappers.lambdaQuery(ConversationMessage.class).eq(ConversationMessage::getConversationId, messageChat.getConversationId())
                //.ne(ConversationMessage::getContentType, ContentTypeEnum.reply_summary.getCode())
                .notIn(ConversationMessage::getContentType, Arrays.asList(ContentTypeEnum.read_article.getCode(),
                        ContentTypeEnum.welcome.getCode(),
                        ContentTypeEnum.doc_link.getCode(),
                        ContentTypeEnum.read_doc.getCode(),
                        ContentTypeEnum.virtual_root.getCode())));
        if (messages.isEmpty()) {
            return question;
        }
        log.info("message信息：{}", messages);
        Map<String, ConversationMessage> cache = messages.stream().collect(Collectors.toMap(ConversationMessage::getMessageId, k -> k));
        String parentId = messageChat.getParentId();
        ConversationMessage conversationMessage = cache.get(parentId);
        String model = systemProperties.getChatLiteModelName();
        Integer requestToken = systemProperties.getChatLiteMaxToken();
        StringBuilder sb = new StringBuilder();
        int tokens = 0;
        Stack<ChatMessage> stack = new Stack<>();
        List<String> rewriteUserPrompt = systemProperties.getRewriteUserPrompt();
        int size = rewriteUserPrompt.size();
        for (int i = size - 1; i >= 0; i--) {
            String rewritePrompt = rewriteUserPrompt.get(i);
            stack.push(new ChatMessage(ChatMessageRole.USER.value(), rewritePrompt));
            sb.append(rewritePrompt);
        }
        List<ChatMessage> chatMessages = Lists.newArrayList();
        List<String> systemPrompt = systemProperties.getSystemPrompt(ChatLanguageEnum.English);
        if (CollectionUtil.isNotEmpty(systemPrompt)) {
            for (String s : systemPrompt) {
                chatMessages.add(new ChatMessage(ChatMessageRole.SYSTEM.value(), s));
                sb.append(s);
            }
        }
        Boolean isQuestion = null;
        AtomicReference<String> atomicReference = new AtomicReference<>();
        while (Objects.nonNull(conversationMessage)) {
            MessageEnum status = conversationMessage.getStatus();
            String parent = conversationMessage.getParentId();
            if (Objects.equals(status, MessageEnum.SUCCESS)) {
                tokens = JTokkitHelper.countTokens(sb + conversationMessage.getContent(), model);
                if (tokens > requestToken) {
                    if (Objects.equals(parentId, conversationMessage.getMessageId())) {
                        return question;
                    }
                    break;
                } else {
                    if (Objects.isNull(isQuestion)) {
                        isQuestion = true;
                    } else if (!Objects.equals(ContentTypeEnum.intent, conversationMessage.getContentType())) {
                        isQuestion = false;
                    }
                    sb.append(conversationMessage.getContent());
                    ChatMessage chatMessage = toChatMessage(conversationMessage, locale, isQuestion, atomicReference);
                    if (Objects.nonNull(chatMessage)) {
                        stack.push(chatMessage);
                    }

                }
            }
            conversationMessage = cache.get(parent);
        }

        while (!stack.isEmpty()) {
            chatMessages.add(stack.pop());
        }
        if (chatMessages.isEmpty()) {
            return question;
        }
        ChatCompletionRequest.ChatCompletionRequestBuilder builder = ChatCompletionRequest.builder();
        if (Objects.nonNull(systemProperties.getTemperature())) {
            builder.temperature(systemProperties.getTemperature());
        }
        Double top = systemProperties.getTop();
        if (Objects.nonNull(top)) {
            builder.topP(top);
        }
        builder.model(model).messages(chatMessages);
        if (log.isInfoEnabled()) {
            log.info("传递参数的信息：{}", chatMessages);
        }
        messageChat.setModel(model);
        messageChat.setRequestToken(tokens);
        //Long start = System.currentTimeMillis();
        try {
            // 测试环境和生成环境调的API 不一样
            String profile = webConfig.profile;
            ChatCompletionResult chatCompletion;
            chatCompletion = openAIService.createChatCompletion(builder.build());
            List<ChatCompletionChoice> choices = chatCompletion.getChoices();
            if (Objects.nonNull(choices) && !choices.isEmpty()) {
                ChatCompletionChoice chatCompletionChoice = choices.get(0);
                if (Objects.nonNull(chatCompletionChoice)) {
                    ChatMessage message = chatCompletionChoice.getMessage();
                    if (Objects.nonNull(message)) {
                        String content1 = message.getContent();
                        if (content1.startsWith("问题：")) {
                            content1 = content1.replace("问题：", "");
                        }
                        return content1;
                    }
                }
            }
            Usage usage = chatCompletion.getUsage();
            if (Objects.nonNull(usage)) {
                messageChat.setRequestToken((int) usage.getPromptTokens());
                messageChat.setResponseToken((int) usage.getCompletionTokens());
            }
            log.info("返回结果不符合要求，messageId:{}", messageChat.getMessageId());
        } catch (OpenAiHttpException httpException) {
            log.error(httpException.getMessage(), httpException);
            // throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR,
            //         StrUtil.format("调用openai报错：{}", httpException.getMessage()));
        }
        return question;
    }


    @Resource
    private IUserService userService;


    @Resource
    private RedisTemplate<String, String> stringRedisTemplate;

    private void saveMessageResponse(ConversationMessage messageChat, DocumentInfo documentInfo, String sId) {
        String stopCacheKey;
        if (StrUtil.isNotBlank(sId)) {
            stopCacheKey = MessageConstants.buildStopMsgKey(sId);
        } else {
            stopCacheKey = MessageConstants.buildStopMsgKey(messageChat.getCreateId(), messageChat.getConversationId(), messageChat.getMessageId());
        }
        String value = stringRedisTemplate.opsForValue().get(stopCacheKey);
        if (StrUtil.isNotBlank(value)) {
            redisTemplate.delete(stopCacheKey);
            return;
        }
        messageChat.setRole(ChatRoleEnum.assistant);
        messageChat.setCreateTime(LocalDateTime.now());
        long count = messageService.count(Wrappers.lambdaQuery(ConversationMessage.class)
                .eq(ConversationMessage::getConversationId, messageChat.getConversationId())
                .eq(ConversationMessage::getMessageId, messageChat.getMessageId()));
        String model = messageChat.getModel();
        if (count == 0) {
            messageService.save(messageChat);
        } else {
            LambdaUpdateWrapper<ConversationMessage> updateWrapper = Wrappers
                    .lambdaUpdate(ConversationMessage.class)
                    .eq(ConversationMessage::getMessageId, messageChat.getMessageId())
                    .eq(ConversationMessage::getConversationId, messageChat.getConversationId())
                    .set(ConversationMessage::getIntentId, messageChat.getIntentId())
                    .set(ConversationMessage::getModel, messageChat.getModel())
                    .set(ConversationMessage::getContentType, messageChat.getContentType().getCode())
                    .set(ConversationMessage::getRequestToken, messageChat.getRequestToken())
                    .set(ConversationMessage::getResponseToken, messageChat.getResponseToken())
                    .set(ConversationMessage::getQuestion, messageChat.getQuestion());

            if (StrUtil.isBlank(value)) {
                updateWrapper.set(ConversationMessage::getStatus, messageChat.getStatus().getCode())
                        .set(ConversationMessage::getSuggest, messageChat.getSuggest()).set(ConversationMessage::getReference, messageChat.getReference()).set(ConversationMessage::getContent, messageChat.getContent());
            }
            messageService.update(updateWrapper);
        }
        LambdaUpdateWrapper<ConversationInfo> updateWrapper = Wrappers.lambdaUpdate(ConversationInfo.class).eq(ConversationInfo::getId, messageChat.getConversationId());
        MessageEnum status = messageChat.getStatus();
        if (Objects.nonNull(status)) {
            if (!status.isError()) {
                String content = MessageUtil.getContent(messageChat);
                if (StrUtil.isNotBlank(content)) {
                    updateWrapper.set(ConversationInfo::getDescription, content);
                }
            }
        }
        updateWrapper.set(ConversationInfo::getUpdateTime, LocalDateTime.now())
                .set(ConversationInfo::getLastMessageTime, messageChat.getCreateTime());
        if (Objects.nonNull(documentInfo)) {
            updateWrapper.set(ConversationInfo::getTitle, documentInfo.getDocName())
                    .set(ConversationInfo::getDocId, documentInfo.getId());
        }
        update(updateWrapper);
        ContentTypeEnum contentType = messageChat.getContentType();
        if (Objects.equals(contentType, ContentTypeEnum.reply_summary)) {
            // 如果超过5次 则设置信息
            long count2 = count(Wrappers.lambdaQuery(ConversationInfo.class).eq(ConversationInfo::getCreateId, messageChat.getCreateId()).eq(ConversationInfo::getType, ConversationTypeEnum.CHAT_INDEX.getCode()));
            UserInfoCommand userInfoCommand = new UserInfoCommand();
            userInfoCommand.setExpandReadAll(count2 <= 5);
            userInfoCommand.setUserId(messageChat.getCreateId());
            userService.updateUserSettingsAsync(userInfoCommand);
            if (Objects.nonNull(documentInfo)) {
                messageService.update(Wrappers.lambdaUpdate(ConversationMessage.class).eq(ConversationMessage::getMessageId, messageChat.getParentId()).eq(ConversationMessage::getConversationId, messageChat.getConversationId()).set(ConversationMessage::getContent, documentInfo.getDocumentId()).isNull(ConversationMessage::getContent));
            }
        }
        stringRedisTemplate.delete(stopCacheKey);
    }

    @Resource
    private IndexApiService indexApiService;


    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @Slf4j
    public static class Message {
        @ApiModelProperty("message的唯一标识")
        private String messageId;

        @ApiModelProperty("会话的唯一标识")
        private String conversationId;


        private String source;


        private String connectId;

        @ApiModelProperty("内容信息，包含markdown格式")
        private String content;


        @ApiModelProperty(value = "message的类型,即文本或者图文", allowableValues = "text")
        private MessageTypeEnum type;


        @ApiModelProperty(value = "内容的类型，整体上分为三类：文本，快捷操作，阅读全文,摘要及可能问到的问题,带有来源的信息", allowableValues = "text")
        private ContentTypeEnum contentType;


        public ContentTypeEnum getContentType() {
            if (Objects.equals(contentType, ContentTypeEnum.text)) {
                return contentType;
            }
            String status = getStatus();
            if (!Objects.equals(status, MESSAGE_SUCCESS_STATUS)
                    && !Objects.equals(status, MESSAGE_RUNNING_STATUS)
                    && !Objects.equals(status, MESSAGE_TOKEN_EXCEEDING_STATUS)
            ) {
                this.contentType = ContentTypeEnum.text;
            }
            return contentType;
        }

        @ApiModelProperty(value = "创建者id")
        private Long createId;
        @ApiModelProperty(value = "创建者id")
        @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
        private LocalDateTime createTime;

        private MessageChatVO.TextVO suggest;


        @ApiModelProperty(value = "来源信息")
        private MessageChatVO.TextVO reference;

        private List<MsgDTO> input;

        private String title;


        @ApiModelProperty(value = "反馈信息，当值为空时未设置，值的含义是赞或者踩或没有设置", allowableValues = "like,dislike,")
        private MessageLikeEnum like = MessageLikeEnum.unknown;

        public String getContent() {
            if (Objects.isNull(content) && Objects.nonNull(input)) {
                this.content = JacksonUtils.writeValueAsString(input);
            }
            return content;
        }

        public void text(String text) {
            if (Objects.isNull(this.input)) {
                this.input = Lists.newArrayList();
            }
            this.input.add(MsgDTO.text(text));
        }

        public void images(UploadObjConfigVO... images) {
            if (Objects.nonNull(images)) {
                if (Objects.isNull(this.input)) {
                    this.input = Lists.newArrayList();
                }
                for (UploadObjConfigVO uploadObjConfigVO : images) {
                    String objId = uploadObjConfigVO.getObjId();
                    String buketName = uploadObjConfigVO.getBucketName();
                    if (StrUtil.isBlank(objId) || StrUtil.isBlank(buketName)) {
                        log.error("{}:{}:照片的objId或者bucketName不存在", getConversationId(), getMessageId());
                        continue;
                    }
                    String downloadUrl = uploadObjConfigVO.getDownloadUrl();
                    if (StrUtil.isBlank(downloadUrl) || downloadUrl.startsWith("http")) {
                        IS3Service is3Service = S3Config.getByBucket(buketName);
                        if (Objects.isNull(is3Service)) {
                            log.error("{}:{}:照片的bucket:{}客户端不存在", getConversationId(), getMessageId(), buketName);
                            continue;
                        }
                        String suffix = StrUtil.isBlank(uploadObjConfigVO.getSuffix()) ? "png" : uploadObjConfigVO.getSuffix().toLowerCase();
                        uploadObjConfigVO.setDownloadUrl(is3Service.downloadPresignedUrl(objId, Constants.DOWNLOAD_URL_EXPIRE_SECOND, StrUtil.format("image/{}", suffix), StrUtil.format("inline; filename=\"{}.{}\";", objId, suffix), CACHE_MAX_AGE).toString());
                    }
                    input.add(MsgDTO.image(uploadObjConfigVO));
                }
            }
        }

        public void video(UploadObjConfigVO... video) {
            if (Objects.nonNull(video)) {
                if (Objects.isNull(this.input)) {
                    this.input = Lists.newArrayList();
                }
                for (UploadObjConfigVO uploadObjConfigVO : video) {
                    String objId = uploadObjConfigVO.getObjId();
                    String buketName = uploadObjConfigVO.getBucketName();
                    if (StrUtil.isBlank(objId) || StrUtil.isBlank(buketName)) {
                        log.error("{}:{}:视频的objId或者bucketName不存在", getConversationId(), getMessageId());
                        continue;
                    }
                    IS3Service is3Service = S3Config.getByBucket(buketName);
                    if (Objects.isNull(is3Service)) {
                        log.error("{}:{}:视频的bucket:{}客户端不存在", getConversationId(), getMessageId(), buketName);
                        continue;
                    }
                    String suffix = StrUtil.isBlank(uploadObjConfigVO.getSuffix()) ? "mp4" : uploadObjConfigVO.getSuffix().toLowerCase();
                    uploadObjConfigVO.setDownloadUrl(is3Service.downloadPresignedUrl(objId, Constants.DOWNLOAD_URL_EXPIRE_SECOND, StrUtil.format("video/{}", suffix), StrUtil.format("inline; filename=\"{}.{}\";", objId, suffix), CACHE_MAX_AGE).toString());
                    input.add(MsgDTO.video(uploadObjConfigVO));
                }
            }

        }


        @ApiModelProperty("父的messageId")
        private String parentMessageId;
        private Integer progress;


        private String sendTime;


        @ApiModelProperty("请求的状态")
        private String status;
        private ChatRoleEnum role;

        private String finished;

        private String question;

    }

    private void closeSse(String sseKey) {
        msgSseEmitterService.close(sseKey);
    }


    private ChatMessage toChatMessage(ConversationMessage conversationMessage, Locale locale, Boolean isQuestion, AtomicReference<String> softReference) {
        String intentId = conversationMessage.getIntentId();
        String messageId = conversationMessage.getMessageId();
        ContentTypeEnum contentType = conversationMessage.getContentType();
        String content = conversationMessage.getContent();
        if (StrUtil.isBlank(content)) {
            content = conversationMessage.getLongContent();
        }
        if (Objects.equals(contentType, ContentTypeEnum.intent)) {
            if (Objects.equals(messageId, intentId)) {
                //content = "您选择的文本：\n" + content;
                String text = softReference.get();
                if (Objects.isNull(text)) {
                    return new ChatMessage(ChatMessageRole.USER.value(), content);
                } else {
                    return new ChatMessage(ChatMessageRole.USER.value(), StrUtil.format(text, content));
                }
            } else {
                if (Objects.equals(conversationMessage.getRole(), ChatRoleEnum.assistant)) {
                    return null;
                }
                if (Objects.equals(isQuestion, true)) {
                    String intentContent = systemProperties.getIntentContent(content, locale);
                    if (Objects.equals(intentContent, content)) {
                        content = intentContent;
                        softReference.set(null);
                    } else {
                        softReference.set(intentContent);
                        return null;
                    }
                }
            }
        } else if (Objects.equals(contentType, ContentTypeEnum.reply_summary)) {
            content = "Doc Summary:\n" + content;
            softReference.set(null);
        } else if (Objects.equals(contentType, ContentTypeEnum.input)
                || Objects.equals(contentType, ContentTypeEnum.reply_input)) {
            List<MsgDTO> msg = JacksonUtils.readValueAsList(content, MsgDTO.class);
            StringBuilder sb = new StringBuilder();
            for (MsgDTO msgDTO : msg) {
                switch (msgDTO.getType()) {
                    case INPUT_TEXT_TYPE:
                        sb.append(msgDTO.textValue());
                        break;
                    default:
                        throw new BusinessException(RespCode.INTERNAL_SERVER_ERROR, "暂不支持图片和视频");
                }
            }
            content = sb.toString();

        } else {
            softReference.set(null);
        }
        return new ChatMessage(conversationMessage.getRole().getChatMessageRole().value(), content);
    }


    @Resource(name = "llmGatewayService")
    private LlmGatewayService openAIService;


}




